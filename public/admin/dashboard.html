<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Analytics | LAKSHYA 2K26</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- COSMIC ADMIN THEME --- */
        :root {
            --primary-color: #00d2ff;
            --secondary-color: #3a7bd5;
            --accent-color: #ff00cc; 
            --bg-color: #050510;
            --card-bg: #151520; 
            --text-color: #ffffff;
            --border-color: rgba(255, 255, 255, 0.1);
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            display: flex; min-height: 100vh; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased; 
        }

        .bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('../assets/admin-block.jpg') no-repeat center/cover; z-index: -2; opacity: 0.4; }
        .overlay-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,15,0.9); z-index: -1; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); background: var(--card-bg); border-right: 1px solid var(--border-color); 
            padding: 2rem; display: flex; flex-direction: column; z-index: 1000; height: 100vh; position: sticky; top: 0; 
            transition: transform 0.3s ease-in-out;
        }
        .logo { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 900; color: var(--primary-color); margin-bottom: 3rem; text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .menu { list-style: none; flex-grow: 1; } .menu li { margin-bottom: 1rem; }
        .menu a { text-decoration: none; color: #ccc; display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 8px; transition: 0.3s; border: 1px solid transparent; }
        .menu a:hover, .menu a.active { background: rgba(0, 210, 255, 0.1); color: var(--primary-color); border-color: rgba(0, 210, 255, 0.2); }
        .logout { color: #ff4444; cursor: pointer; margin-top: auto; }

        /* --- MOBILE HEADER --- */
        .mobile-header {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            z-index: 1100; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .mobile-logo { font-family: 'Montserrat', sans-serif; font-weight: 900; color: white; font-size: 1.2rem; }
        .menu-toggle { font-size: 1.5rem; color: var(--primary-color); cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        .close-sidebar-btn { display: none; font-size: 1.2rem; color: white; cursor: pointer; }

        /* --- MAIN CONTENT --- */
        .main { flex-grow: 1; padding: 2rem; overflow-y: auto; z-index: 1; width: 100%; }
        
        .header { display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h2 { font-family: 'Montserrat', sans-serif; font-size: 1.8rem; margin: 0; }

        /* Stats Button */
        .btn-stats {
            background: linear-gradient(135deg, #ff00cc, #3a7bd5);
            color: white; padding: 10px 20px; border-radius: 8px; border: none;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 5px 15px rgba(255, 0, 204, 0.3); transition: 0.3s; font-size: 0.9rem;
        }
        .btn-stats:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 0, 204, 0.5); }

        /* --- CONTROLS BAR --- */
        .controls-bar {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 12px; margin-bottom: 25px;
            display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
        }
        .control-label { font-weight: 600; color: #aaa; font-size: 0.9rem; }
        
        select {
            padding: 10px 15px; background: #151520; border: 1px solid #444; color: white; 
            border-radius: 6px; outline: none; font-family: 'Poppins'; min-width: 250px; cursor: pointer;
        }
        select:focus { border-color: var(--primary-color); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); 
            padding: 1.5rem; border-radius: 15px; position: relative; overflow: hidden; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.05); }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary-color); }
        
        .stat-card h3 { font-size: 2.5rem; margin-bottom: 5px; color: white; font-family: 'Montserrat', sans-serif; }
        .stat-card p { color: #aaa; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .stat-sub { font-size: 0.8rem; color: #666; margin-top: 5px; }

        /* Charts Layout */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .chart-card { 
            background: var(--card-bg); border: 1px solid var(--border-color); 
            border-radius: 15px; padding: 1.5rem; height: 450px; 
            display: flex; flex-direction: column;
        }
        .chart-card h4 { margin-bottom: 15px; color: #ccc; font-family: 'Montserrat'; }
        .chart-wrapper { flex-grow: 1; position: relative; }

        /* Event Breakdown Grid */
        .section-title { font-family: 'Montserrat'; margin-bottom: 20px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: inline-block; }
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .event-card { 
            background: rgba(255,255,255,0.02); border: 1px solid var(--border-color); 
            padding: 20px; border-radius: 12px; display: flex; flex-direction: column; 
            transition: 0.2s; position: relative;
        }
        .event-card:hover { background: rgba(255,255,255,0.05); border-color: var(--primary-color); transform: translateY(-3px); }
        
        .ec-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .ec-title { font-size: 1rem; font-weight: 600; color: white; line-height: 1.4; }
        .ec-count-badge { 
            background: rgba(0, 210, 255, 0.1); color: var(--primary-color); 
            padding: 5px 12px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; 
            border: 1px solid rgba(0, 210, 255, 0.2);
        }
        
        .ec-progress-container { width: 100%; background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden; margin-top: auto; }
        .ec-progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-radius: 3px; width: 0%; transition: width 1s ease-out; }
        
        .ec-meta { font-size: 0.8rem; color: #777; margin-top: 10px; display: flex; justify-content: space-between; }

        /* Stats Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #151520; width: 90%; max-width: 450px; padding: 2rem; border-radius: 15px; border: 1px solid var(--border-color); position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); text-align: center; }
        .modal-close { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.5rem; color: #aaa; }
        .modal-icon { font-size: 3rem; color: var(--accent-color); margin-bottom: 15px; }
        .btn-download { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-dl-excel { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50; }
        .btn-dl-excel:hover { background: #4caf50; color: white; }
        .btn-dl-pdf { background: rgba(244, 67, 54, 0.2); color: #ff4444; border: 1px solid #ff4444; }
        .btn-dl-pdf:hover { background: #ff4444; color: white; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .sidebar { position: fixed; left: 0; top: 0; height: 100vh; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .mobile-header { display: flex; }
            .close-sidebar-btn { display: block; }
            .main { width: 100%; margin-left: 0; padding: 1.5rem; padding-top: 90px; }
            .charts-row { grid-template-columns: 1fr; height: auto; }
        }
    </style>
</head>
<body>

    <div class="bg-layer"></div>
    <div class="overlay-layer"></div>

    <div class="mobile-header">
        <div class="mobile-logo">LAKSHYA ADMIN</div>
        <i class="fa-solid fa-bars menu-toggle" onclick="toggleSidebar()"></i>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="logo">
            LAKSHYA ADMIN 
            <i class="fa-solid fa-xmark close-sidebar-btn" onclick="toggleSidebar()"></i>
        </div>
        <ul class="menu">
            <li><a href="dashboard" class="active"><i class="fa-solid fa-gauge-high"></i> Dashboard</a></li>
            <li><a href="registrations"><i class="fa-solid fa-clipboard-list"></i> Registrations</a></li>
            <li><a href="add-event"><i class="fa-solid fa-calendar-plus"></i> Add Event</a></li>
            <li><a href="departments"><i class="fa-solid fa-building-columns"></i> Departments</a></li>
            <li><a href="manage-users"><i class="fa-solid fa-users"></i> Users</a></li>
            <li><a href="committee"><i class="fa-solid fa-user-tie"></i> Committee</a></li>
            <li><a href="setup-scoring"><i class="fa-solid fa-sliders"></i> Setup Scoring</a></li>
            <li><a href="view-scores"><i class="fa-solid fa-square-poll-vertical"></i> View Scores</a></li>
            <li><a onclick="logout()" class="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
    </aside>

    <main class="main">
        <div class="header">
            <div>
                <h2>Analytics Overview</h2>
                <div class="user-info" style="color:#aaa; font-size:0.9rem;">Real-time Registration Insights</div>
            </div>
            <button class="btn-stats" onclick="openStatsModal()">
                <i class="fa-solid fa-file-contract"></i> Download Matrix Report
            </button>
        </div>

        <!-- Department Monitor Control -->
        <div class="controls-bar">
            <span class="control-label"><i class="fa-solid fa-filter"></i> Filter by Department:</span>
            <select id="deptMonitor" onchange="updateDashboardFilter()">
                <option value="all">All Departments (Global View)</option>
                <!-- Departments populated by JS -->
            </select>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalReg">0</h3>
                <p id="regLabel">Total Registrations</p>
                <div class="stat-sub" id="regSub">Loading...</div>
            </div>
            <div class="stat-card" style="--primary-color: #4caf50;"> 
                <h3 id="totalRev" style="color:#4caf50;">₹0</h3>
                <p>Calculated Revenue</p>
                <div class="stat-sub">Actual Payment Data</div>
            </div>
            <div class="stat-card" style="--primary-color: #ffc107;"> 
                <h3 id="paidCount" style="color:#ffc107;">0</h3>
                <p>Paid Registrations</p>
                <div class="stat-sub">Confirmed Seats</div>
            </div>
            <div class="stat-card" style="--primary-color: #00d2ff;"> 
                <h3 id="activeEvents">0</h3>
                <p>Events with Regs</p>
                <div class="stat-sub">Showing interest</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-row">
            <div class="chart-card">
                <h4 id="chartTitle">Top Events (By Count)</h4>
                <div class="chart-wrapper">
                    <canvas id="eventTrendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4>Payment Status</h4>
                <div class="chart-wrapper">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Event Breakdown Section -->
        <h3 class="section-title">Detailed Event Breakdown</h3>
        <div class="event-grid" id="eventGrid">
            <!-- Cards injected by JS -->
            <div style="color:#aaa;">Loading event data...</div>
        </div>

    </main>

    <!-- Download Stats Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal-box">
            <span class="modal-close" onclick="closeStatsModal()"><i class="fa-solid fa-xmark"></i></span>
            <div class="modal-icon"><i class="fa-solid fa-table-cells"></i></div>
            <h3 style="color:white; margin-bottom:10px;">Download Matrix Report</h3>
            <p style="color:#aaa; margin-bottom:25px; font-size:0.9rem;">
                Generates a complete matrix: 
                <br><strong>Department vs Event</strong> tables for Total, Paid, and Unpaid.
                <br>Includes Global Summary at the bottom.
            </p>
            <button class="btn-download btn-dl-excel" onclick="downloadStats('excel')">
                <i class="fa-solid fa-file-excel"></i> Export Excel Matrix
            </button>
            <button class="btn-download btn-dl-pdf" onclick="downloadStats('pdf')">
                <i class="fa-solid fa-file-pdf"></i> Export PDF Report
            </button>
        </div>
    </div>

    <script>
        let allRegistrations = [];
        let eventsMap = {};
        let eventTrendChart = null;
        let paymentChartInstance = null;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        async function initDashboard() {
            try {
                const eventsRes = await fetch('/api/events');
                const eventsData = await eventsRes.json();
                eventsData.forEach(e => eventsMap[e.eventId] = e.title);

                const deptRes = await fetch('/api/admin/departments');
                const departments = await deptRes.json();
                const select = document.getElementById('deptMonitor');
                departments.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.name; 
                    opt.innerText = d.name;
                    select.appendChild(opt);
                });

                const regRes = await fetch('/api/admin/all-registrations');
                allRegistrations = await regRes.json();

                updateDashboardFilter();

            } catch (err) { console.error("Dashboard Init Error:", err); }
        }

        function updateDashboardFilter() {
            const selectedDept = document.getElementById('deptMonitor').value;
            
            let filteredRegs = allRegistrations;
            let filterLabel = "Global Count";

            if (selectedDept !== 'all') {
                filteredRegs = allRegistrations.filter(r => (r.deptName || r.dept) === selectedDept);
                filterLabel = `For Department: ${selectedDept}`;
            }

            const totalReg = filteredRegs.length;
            const paidRegs = filteredRegs.filter(r => r.paymentStatus === 'COMPLETED').length;
            const pendingRegs = totalReg - paidRegs;
            
            // --- ACTUAL REVENUE CALCULATION FIX ---
            // Replaces the old "paidRegs * 200" logic
            const revenue = filteredRegs.reduce((sum, r) => {
                if (r.paymentStatus === 'COMPLETED') {
                    const amt = parseFloat(r.amountPaid);
                    // Use actual amount, or 200 if missing (legacy)
                    return sum + (isNaN(amt) ? 200 : amt); 
                }
                return sum;
            }, 0);
            
            const eventCounts = {};
            filteredRegs.forEach(r => {
                const eTitle = eventsMap[r.eventId] || r.eventId;
                eventCounts[eTitle] = (eventCounts[eTitle] || 0) + 1;
            });
            const activeEventsCount = Object.keys(eventCounts).length;

            document.getElementById('totalReg').innerText = totalReg;
            document.getElementById('regSub').innerText = filterLabel;
            
            // Format Revenue with Commas
            document.getElementById('totalRev').innerText = '₹' + revenue.toLocaleString('en-IN');
            
            document.getElementById('paidCount').innerText = paidRegs;
            document.getElementById('activeEvents').innerText = activeEventsCount;

            renderEventTrendChart(eventCounts);
            renderPaymentChart(paidRegs, pendingRegs);
            renderEventGrid(eventCounts);
        }

        function renderEventTrendChart(dataObj) {
            const ctx = document.getElementById('eventTrendChart').getContext('2d');
            const sortedEntries = Object.entries(dataObj).sort((a, b) => b[1] - a[1]).slice(0, 10); 
            const labels = sortedEntries.map(e => e[0]);
            const data = sortedEntries.map(e => e[1]);

            if (eventTrendChart) eventTrendChart.destroy();

            eventTrendChart = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Registrations',
                        data: data,
                        backgroundColor: 'rgba(0, 210, 255, 0.6)',
                        borderColor: '#00d2ff',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#aaa', precision: 0 } },
                        y: { grid: { display: false }, ticks: { color: '#fff' } }
                    }
                }
            });
        }

        function renderPaymentChart(paid, pending) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            if (paymentChartInstance) paymentChartInstance.destroy();

            paymentChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Pending'],
                    datasets: [{
                        data: [paid, pending],
                        backgroundColor: ['#4caf50', '#222'], 
                        borderColor: '#151520',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#fff' } }
                    },
                    cutout: '70%'
                }
            });
        }

        function renderEventGrid(dataObj) {
            const container = document.getElementById('eventGrid');
            container.innerHTML = '';

            const sortedEntries = Object.entries(dataObj).sort((a, b) => b[1] - a[1]);
            const maxCount = sortedEntries.length > 0 ? sortedEntries[0][1] : 1;

            if(sortedEntries.length === 0) {
                container.innerHTML = '<p style="color:#666; col-span:3;">No registrations found for this selection.</p>';
                return;
            }

            sortedEntries.forEach(([title, count]) => {
                const percentage = (count / maxCount) * 100;
                
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="ec-header">
                        <div class="ec-title">${title}</div>
                        <div class="ec-count-badge">${count}</div>
                    </div>
                    <div class="ec-progress-container">
                        <div class="ec-progress-bar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="ec-meta">
                        <span>Registrations</span>
                        <span>${Math.round(percentage)}% of Top</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- MATRIX DOWNLOAD STATISTICS LOGIC ---

        function openStatsModal() { document.getElementById('statsModal').style.display = 'flex'; }
        function closeStatsModal() { document.getElementById('statsModal').style.display = 'none'; }

        // Helper to generate the 2D Matrix Data
        function prepareMatrixData() {
            // 1. Collect unique Departments and Events (Sorted)
            const depts = new Set();
            const eventIds = new Set();
            
            allRegistrations.forEach(r => {
                depts.add(r.deptName || r.dept || 'Other');
                eventIds.add(r.eventId);
            });

            const sortedDepts = Array.from(depts).sort();
            // Map Event IDs to Titles
            const sortedEventTitles = Array.from(eventIds).map(id => eventsMap[id] || id).sort();

            // 2. Initialize Matrices
            // Structure: matrix[deptName][eventName] = count
            const matrixTotal = {};
            const matrixPaid = {};
            const matrixUnpaid = {};
            
            // Initialize with 0s
            sortedDepts.forEach(d => {
                matrixTotal[d] = {};
                matrixPaid[d] = {};
                matrixUnpaid[d] = {};
                sortedEventTitles.forEach(e => {
                    matrixTotal[d][e] = 0;
                    matrixPaid[d][e] = 0;
                    matrixUnpaid[d][e] = 0;
                });
            });

            // 3. Fill Data
            allRegistrations.forEach(r => {
                const d = r.deptName || r.dept || 'Other';
                const e = eventsMap[r.eventId] || r.eventId;
                const isPaid = r.paymentStatus === 'COMPLETED';

                if(matrixTotal[d] && matrixTotal[d][e] !== undefined) {
                    matrixTotal[d][e]++;
                    if(isPaid) matrixPaid[d][e]++;
                    else matrixUnpaid[d][e]++;
                }
            });

            // 4. Helper to convert Matrix Object to Array of Arrays (Rows) with Row Totals
            const generateRows = (matrixObj) => {
                const rows = [];
                // Column Totals Tracker
                const colTotals = new Array(sortedEventTitles.length).fill(0);
                let grandTotal = 0;

                sortedDepts.forEach(d => {
                    const rowData = [d];
                    let rowTotal = 0;
                    sortedEventTitles.forEach((e, idx) => {
                        const val = matrixObj[d][e];
                        rowData.push(val);
                        rowTotal += val;
                        colTotals[idx] += val;
                    });
                    rowData.push(rowTotal); // Row Total Column
                    grandTotal += rowTotal;
                    rows.push(rowData);
                });

                // Total Row
                const totalRow = ["TOTAL", ...colTotals, grandTotal];
                rows.push(totalRow);
                return rows;
            };

            return {
                headers: ["DEPT NAME/EVENT", ...sortedEventTitles, "TOTAL"],
                rowsTotal: generateRows(matrixTotal),
                rowsPaid: generateRows(matrixPaid),
                rowsUnpaid: generateRows(matrixUnpaid),
                eventTitles: sortedEventTitles
            };
        }

        function downloadStats(type) {
            const matrix = prepareMatrixData();
            const { headers, rowsTotal, rowsPaid, rowsUnpaid, eventTitles } = matrix;

            // Global Summary Table (Last section of image)
            // Transpose the Column Totals from the main matrices to create this small summary
            const globalSummary = [];
            const totalRowTotal = rowsTotal[rowsTotal.length - 1]; // Last row is TOTAL row
            const totalRowPaid = rowsPaid[rowsPaid.length - 1];
            const totalRowUnpaid = rowsUnpaid[rowsUnpaid.length - 1];

            // Start from index 1 to exclude "TOTAL" label, end before last index
            for(let i=0; i < eventTitles.length; i++) {
                globalSummary.push([
                    eventTitles[i], // Event Name
                    totalRowTotal[i+1], // Total
                    totalRowPaid[i+1], // Paid
                    totalRowUnpaid[i+1] // Unpaid
                ]);
            }
            // Add Total Row for Summary
            globalSummary.push([
                "TOTAL",
                totalRowTotal[totalRowTotal.length-1],
                totalRowPaid[totalRowPaid.length-1],
                totalRowUnpaid[totalRowUnpaid.length-1]
            ]);


            if (type === 'excel') {
                const wb = XLSX.utils.book_new();
                const wsData = [];

                // 1. TOTAL TABLE
                wsData.push(headers);
                wsData.push(...rowsTotal);
                wsData.push([]); // Spacer

                // 2. PAID TABLE
                wsData.push(["PAID REGISTRATIONS"]);
                wsData.push(headers);
                wsData.push(...rowsPaid);
                wsData.push([]); // Spacer

                // 3. UNPAID TABLE
                wsData.push(["UNPAID REGISTRATIONS"]);
                wsData.push(headers);
                wsData.push(...rowsUnpaid);
                wsData.push([]); // Spacer

                // 4. GLOBAL SUMMARY
                wsData.push(["GLOBAL REGISTRATIONS COUNT"]);
                wsData.push(["EVENT NAME", "TOTAL", "PAID", "UNPAID"]);
                wsData.push(...globalSummary);

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Analytics_Matrix");
                XLSX.writeFile(wb, "LAKSHYA_Matrix_Report.xlsx");

            } else {
                // PDF Generation
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a3'); // Landscape A3 for width

                doc.setFontSize(16);
                doc.text("LAKSHYA 2K26 - Matrix Report", 14, 15);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

                let currentY = 30;

                const addTable = (title, head, body) => {
                    doc.text(title, 14, currentY);
                    doc.autoTable({
                        head: [head],
                        body: body,
                        startY: currentY + 5,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [0, 210, 255], textColor: 0, fontStyle: 'bold' }
                    });
                    currentY = doc.lastAutoTable.finalY + 15;
                };

                addTable("ALL REGISTRATIONS (Department vs Event)", headers, rowsTotal);
                
                // Check space
                if (currentY > 200) { doc.addPage(); currentY = 20; }
                addTable("PAID REGISTRATIONS", headers, rowsPaid);

                if (currentY > 200) { doc.addPage(); currentY = 20; }
                addTable("UNPAID REGISTRATIONS", headers, rowsUnpaid);

                if (currentY > 200) { doc.addPage(); currentY = 20; }
                addTable("GLOBAL REGISTRATIONS SUMMARY", ["EVENT NAME", "TOTAL", "PAID", "UNPAID"], globalSummary);

                doc.save("LAKSHYA_Matrix_Report.pdf");
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../login';
        }

        initDashboard();
    </script>
</body>
</html>
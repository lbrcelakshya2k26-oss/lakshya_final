<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Management | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    
    <!-- <script src="/js/common.js"></script> -->

    <style>
        :root { 
            --primary: #00d2ff; 
            --glass-bg: rgba(20, 20, 35, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --sidebar-width: 260px;
        }
        
        body { 
            background-color: #050510; 
            color: white; 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Reusing Sidebar style from other admin pages */
        .sidebar {
            width: var(--sidebar-width); height: 100vh;
            background: var(--glass-bg); border-right: 1px solid var(--glass-border);
            padding: 2rem; display: flex; flex-direction: column;
        }
        .logo { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 900; color: var(--primary); margin-bottom: 3rem; text-align:center; }
        .menu { list-style: none; padding: 0; margin: 0; } 
        .menu li { margin-bottom: 1rem; }
        .menu a { text-decoration: none; color: #ccc; display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; transition: 0.3s; font-size: 0.95rem; }
        .menu a:hover, .menu a.active { background: rgba(0, 210, 255, 0.1); color: var(--primary); }
        .logout { color: #ff4444; cursor: pointer; margin-top: auto; border: 1px solid rgba(255,68,68,0.1); padding: 10px; border-radius: 8px; text-align: center; }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h2 { margin: 0; font-family: 'Montserrat', sans-serif; }

        .filters { display: flex; gap: 15px; margin-bottom: 20px; }
        .filter-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: #aaa; padding: 8px 16px; border-radius: 50px; cursor: pointer; transition: 0.3s;
        }
        .filter-btn:hover, .filter-btn.active { background: var(--primary); color: black; border-color: var(--primary); }

        .query-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }

        .q-card {
            background: rgba(30,30,40,0.6);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            transition: 0.3s;
            position: relative;
        }
        .q-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        
        .q-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 10px; text-transform: uppercase; }
        .q-subject { font-weight: 700; font-size: 1.1rem; margin-bottom: 5px; color: white; }
        .q-user { font-size: 0.9rem; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .q-desc { font-size: 0.9rem; color: #ccc; margin-bottom: 20px; line-height: 1.5; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

        .q-footer { display: flex; justify-content: space-between; align-items: center; }
        
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .st-open { color: #ffc107; border: 1px solid #ffc107; background: rgba(255, 193, 7, 0.1); }
        .st-resolved { color: #00ff88; border: 1px solid #00ff88; background: rgba(0, 255, 136, 0.1); }

        .btn-reply {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border: none; color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        .btn-reply:hover { opacity: 0.9; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #151520; width: 90%; max-width: 500px; padding: 30px; border-radius: 12px; border: 1px solid var(--primary); }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
        .reply-area { width: 100%; min-height: 150px; background: rgba(255,255,255,0.05); border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-family: inherit; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">ADMIN PANEL</div>
        <ul class="menu">
            <li><a href="/admin/dashboard"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
            <li><a href="/admin/registrations"><i class="fa-solid fa-users"></i> Registrations</a></li>
            <li><a href="#" class="active"><i class="fa-solid fa-headset"></i> Queries</a></li>
        </ul>
        <div class="logout" onclick="location.href='/login'">Logout</div>
    </aside>

    <main class="main">
        <div class="header">
            <h2>Query Resolution</h2>
            <button onclick="loadQueries()" style="background:none; border:1px solid #555; color:white; padding:8px 15px; border-radius:6px; cursor:pointer;"><i class="fa-solid fa-rotate"></i> Refresh</button>
        </div>

        <div class="filters">
            <div class="filter-btn active" onclick="filterData('OPEN', this)">Open</div>
            <div class="filter-btn" onclick="filterData('RESOLVED', this)">Resolved</div>
            <div class="filter-btn" onclick="filterData('ALL', this)">All</div>
        </div>

        <div id="queryContainer" class="query-grid">
            <div style="grid-column: 1/-1; text-align:center; padding:50px; color:#666;">
                <i class="fa-solid fa-spinner fa-spin"></i> Loading...
            </div>
        </div>
    </main>

    <!-- Reply Modal -->
    <div class="modal" id="replyModal">
        <div class="modal-content">
            <div class="modal-title">Reply to Participant</div>
            <p style="font-size:0.9rem; color:#ccc; margin-bottom:10px;">An email will be sent to the user.</p>
            <textarea id="replyText" class="reply-area" placeholder="Type your resolution here..."></textarea>
            <div class="modal-actions">
                <button onclick="closeModal()" style="padding:10px 20px; background:none; border:1px solid #666; color:#ccc; border-radius:6px; cursor:pointer;">Cancel</button>
                <button onclick="submitResolution()" id="btnSend" style="padding:10px 20px; background:var(--primary); border:none; color:black; font-weight:bold; border-radius:6px; cursor:pointer;">Send & Resolve</button>
            </div>
        </div>
    </div>

    <script>
        let allQueries = [];
        let currentFilter = 'OPEN';
        let activeQueryId = null;

        async function loadQueries() {
            const container = document.getElementById('queryContainer');
            try {
                const res = await fetch('/api/admin/all-queries');
                allQueries = await res.json();
                renderQueries();
            } catch(e) {
                container.innerHTML = `<div style="color:red; text-align:center;">Failed to load data</div>`;
            }
        }

        function filterData(status, btn) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderQueries();
        }

        function renderQueries() {
            const container = document.getElementById('queryContainer');
            container.innerHTML = '';

            const filtered = allQueries.filter(q => currentFilter === 'ALL' || q.status === currentFilter);

            if(filtered.length === 0) {
                container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#666;">No ${currentFilter.toLowerCase()} queries found.</div>`;
                return;
            }

            filtered.forEach(q => {
                const isResolved = q.status === 'RESOLVED';
                const statusBadge = isResolved 
                    ? `<span class="status-badge st-resolved"><i class="fa-solid fa-check"></i> Resolved</span>`
                    : `<span class="status-badge st-open"><i class="fa-solid fa-circle-exclamation"></i> Open</span>`;
                
                const actionBtn = isResolved
                    ? `<span style="font-size:0.8rem; color:#888;">Resolved on ${new Date(q.resolvedAt).toLocaleDateString()}</span>`
                    : `<button class="btn-reply" onclick="openModal('${q.queryId}')"><i class="fa-solid fa-reply"></i> Reply</button>`;

                const html = `
                    <div class="q-card">
                        <div class="q-meta">
                            <span>${q.category}</span>
                            <span>${new Date(q.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="q-subject">${q.subject}</div>
                        <div class="q-user">
                            <i class="fa-solid fa-user"></i> ${q.userName} (${q.rollNo})
                        </div>
                        <div class="q-desc">${q.description}</div>
                        <div class="q-footer">
                            ${statusBadge}
                            ${actionBtn}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function openModal(qid) {
            activeQueryId = qid;
            document.getElementById('replyText').value = '';
            document.getElementById('replyModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('replyModal').style.display = 'none';
            activeQueryId = null;
        }

        async function submitResolution() {
            const reply = document.getElementById('replyText').value.trim();
            if(!reply) return alert("Please enter a reply.");

            const btn = document.getElementById('btnSend');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Sending...'; btn.disabled = true;

            try {
                const res = await fetch('/api/admin/resolve-query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ queryId: activeQueryId, reply: reply })
                });

                if(res.ok) {
                    alert("Query Resolved!");
                    closeModal();
                    loadQueries(); // Refresh list
                } else {
                    alert("Failed to update.");
                }
            } catch(e) {
                alert("Network error");
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }

        window.onload = loadQueries;
    </script>
</body>
</html>
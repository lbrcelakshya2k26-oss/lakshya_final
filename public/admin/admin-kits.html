<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kit Monitoring | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    
    <script src="/js/common.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { 
            --primary-color: #00d2ff; 
            --secondary-color: #3a7bd5; 
            --success-color: #00ff88;
            --glass-bg: rgba(20, 20, 35, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --text-color: #ffffff; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            background-color: #0a0a0a; 
            color: var(--text-color); 
            min-height: 100vh; 
            background-image: url('../assets/admin-block.jpg'); /* Reuse existing asset */
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 12, 0.9); z-index: -1;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header & Controls */
        .header-section {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title h2 {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(45deg, #fff, var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .controls-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .dept-select {
            padding: 10px 15px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary-color);
            color: white;
            border-radius: 8px;
            outline: none;
            min-width: 200px;
            font-family: 'Poppins', sans-serif;
        }
        .dept-select option { background: #000; color: white; }

        .btn-export {
            background: rgba(0, 255, 136, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        .btn-export:hover { background: rgba(0, 255, 136, 0.25); }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--primary-color);
        }
        .stat-card.collected::before { background: var(--success-color); }
        .stat-card.pending::before { background: #ffc107; }

        .stat-val { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #aaa; text-transform: uppercase; }

        /* Table */
        .table-container {
            background: var(--glass-bg);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
        }
        .search-bar {
            width: 100%; padding: 15px 25px;
            background: rgba(255,255,255,0.03);
            border: none; border-bottom: 1px solid var(--glass-border);
            color: white; font-size: 1rem; outline: none;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left; padding: 15px 25px;
            background: rgba(0, 210, 255, 0.1);
            color: var(--primary-color);
            text-transform: uppercase; font-size: 0.8rem;
        }
        td {
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem; color: #ddd;
        }
        tr:hover { background: rgba(255,255,255,0.02); }

        .status-badge {
            padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;
        }
        .bg-success { background: rgba(0, 255, 136, 0.15); color: var(--success-color); border: 1px solid var(--success-color); }
        .bg-pending { background: rgba(255, 193, 7, 0.15); color: #ffc107; border: 1px solid #ffc107; }

        .loading-spinner { padding: 40px; text-align: center; color: #666; font-size: 1.2rem; }

        @media (max-width: 768px) {
            .header-section { flex-direction: column; align-items: flex-start; }
            .controls-group { width: 100%; flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="overlay"></div>

    <div class="main-container">
        
        <div style="margin-bottom: 20px;">
            <a href="/admin/dashboard" style="color: #aaa; text-decoration: none; font-size: 0.9rem;">
                <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <div class="header-section">
            <div class="header-title">
                <h2>Kit Distribution Monitor</h2>
                <p style="color: #888; font-size: 0.9rem;">Track kit eligibility and collection status across departments.</p>
            </div>
            <div class="controls-group">
                <select id="deptSelect" class="dept-select" onchange="fetchKitData()">
                    <option value="All">All Departments</option>
                    <!-- Depts will be populated here -->
                </select>
                <button class="btn-export" onclick="exportToExcel()">
                    <i class="fa-solid fa-file-excel"></i> Export Report
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="totalEligible">0</div>
                <div class="stat-label">Total Eligible</div>
            </div>
            <div class="stat-card collected">
                <div class="stat-val" style="color: var(--success-color);" id="totalCollected">0</div>
                <div class="stat-label">Kits Collected</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-val" style="color: #ffc107;" id="totalPending">0</div>
                <div class="stat-label">Pending Collection</div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <input type="text" id="searchInput" class="search-bar" placeholder="Search by Name, Reg ID, or Department..." onkeyup="filterTable()">
            <table>
                <thead>
                    <tr>
                        <th>Student Details</th>
                        <th>Department</th>
                        <th>Event</th>
                        <th>Status</th>
                        <th>Date Collected</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allData = [];

        // 1. Initial Load: Get Departments & Data
        async function init() {
            // Load Departments Dropdown
            try {
                const res = await fetch('/api/admin/departments');
                const depts = await res.json();
                const select = document.getElementById('deptSelect');
                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.name; // Assuming backend returns { name: "CSE" }
                    opt.innerText = d.name;
                    select.appendChild(opt);
                });
            } catch (e) { console.error("Dept load failed", e); }

            // Fetch Data (Default: All)
            fetchKitData();
        }

        // 2. Fetch Kit Data based on Selection
        async function fetchKitData() {
            const dept = document.getElementById('deptSelect').value;
            const tbody = document.getElementById('tableBody');
            
            tbody.innerHTML = `<tr><td colspan="5" class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> Fetching Data...</td></tr>`;

            try {
                // Call the new backend endpoint
                const res = await fetch(`/api/admin/kit-stats?dept=${encodeURIComponent(dept)}`);
                allData = await res.json();
                
                renderTable(allData);
                updateStats(allData);

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#ff4444;">Failed to load data.</td></tr>`;
            }
        }

        // 3. Render Table
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#666;">No eligible students found.</td></tr>`;
                return;
            }

            data.forEach(row => {
                const collected = row.kitCollected === true;
                const statusBadge = collected 
                    ? `<span class="status-badge bg-success">Collected</span>` 
                    : `<span class="status-badge bg-pending">Pending</span>`;
                
                const collectedDate = row.kitCollectedAt 
                    ? new Date(row.kitCollectedAt).toLocaleDateString() 
                    : '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600;">${row.studentName}</div>
                        <div style="font-size:0.8rem; color:#888;">${row.rollNo || 'N/A'}</div>
                        <div style="font-size:0.75rem; color:#666; font-family:'Courier New';">ID: ${row.registrationId}</div>
                    </td>
                    <td>${row.dept}</td>
                    <td>${row.eventTitle} <br> <span style="font-size:0.75rem; color:var(--primary-color)">${row.eventType}</span></td>
                    <td>${statusBadge}</td>
                    <td>${collectedDate}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. Update Stats Cards
        function updateStats(data) {
            const total = data.length;
            const collected = data.filter(d => d.kitCollected === true).length;
            
            document.getElementById('totalEligible').innerText = total;
            document.getElementById('totalCollected').innerText = collected;
            document.getElementById('totalPending').innerText = total - collected;
        }

        // 5. Filter / Search
        function filterTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(item => 
                (item.studentName && item.studentName.toLowerCase().includes(query)) ||
                (item.registrationId && item.registrationId.toLowerCase().includes(query)) ||
                (item.dept && item.dept.toLowerCase().includes(query))
            );
            renderTable(filtered);
        }

        // 6. Excel Export
        function exportToExcel() {
            if (allData.length === 0) return alert("No data to export");
            
            const exportData = allData.map(item => ({
                "Student Name": item.studentName,
                "Roll No": item.rollNo,
                "Registration ID": item.registrationId,
                "Department": item.dept,
                "Event": item.eventTitle,
                "Status": item.kitCollected ? "Collected" : "Pending",
                "Collection Date": item.kitCollectedAt ? new Date(item.kitCollectedAt).toLocaleDateString() : "-"
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Kit_Report");
            XLSX.writeFile(wb, "Kit_Distribution_Report.xlsx");
        }

        window.onload = init;
    </script>
</body>
</html>
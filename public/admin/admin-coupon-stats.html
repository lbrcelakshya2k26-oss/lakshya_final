<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Analytics | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #00d2ff;
            --secondary-color: #ff00cc;
            --bg-color: #050510;
            --card-bg: #151520;
            --border: rgba(255,255,255,0.1);
        }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg-color); color: white; margin: 0; padding: 20px; }

        .dashboard-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-header h2 { font-family: 'Montserrat', sans-serif; color: var(--primary-color); margin: 0; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 12px;
            text-align: center;
        }
        .stat-num { font-size: 2rem; font-weight: bold; color: white; }
        .stat-label { color: #888; font-size: 0.9rem; text-transform: uppercase; }

        .charts-container {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;
        }
        .chart-box {
            background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 12px; height: 350px;
        }

        .stalls-table {
            width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;
        }
        .stalls-table th, .stalls-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); }
        .stalls-table th { background: rgba(0, 210, 255, 0.1); color: var(--primary-color); }
        .amount-highlight { color: #00ff88; font-weight: bold; }

        @media (max-width: 768px) { .charts-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div>
            <h2>Coupon Analytics</h2>
            <p style="color:#888; margin-top:5px;">Real-time usage and settlement tracking.</p>
        </div>
        <button onclick="window.print()" style="padding:10px 20px; background:#333; color:white; border:none; border-radius:5px; cursor:pointer;">
            <i class="fa-solid fa-print"></i> Report
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-num" id="statIssued" style="color: #00d2ff;">0</div>
            <div class="stat-label">Total Issued</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statRedeemed" style="color: #00ff88;">0</div>
            <div class="stat-label">Total Redeemed</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statPending" style="color: #ffcc00;">0</div>
            <div class="stat-label">Pending Usage</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statValue">₹0</div>
            <div class="stat-label">Est. Payout Value</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <h4 style="margin-bottom:15px;">Hourly Redemption Rate</h4>
            <canvas id="timeChart"></canvas>
        </div>
        <div class="chart-box">
            <h4 style="margin-bottom:15px;">Department Usage</h4>
            <canvas id="deptChart"></canvas>
        </div>
    </div>

    <h3 style="margin-bottom:15px; color:#fff;">Stall Settlement</h3>
    <table class="stalls-table">
        <thead>
            <tr>
                <th>Stall Name</th>
                <th>Coupons Scanned</th>
                <th>Last Active</th>
                <th>Total Payout (₹50/unit)</th>
            </tr>
        </thead>
        <tbody id="stallTableBody">
            <tr><td colspan="4" style="text-align:center; color:#666;">Loading Data...</td></tr>
        </tbody>
    </table>

    <script>
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/coupon-analytics');
                const data = await res.json();

                // 1. Update Top Stats
                document.getElementById('statIssued').innerText = data.totalIssued;
                document.getElementById('statRedeemed').innerText = data.totalRedeemed;
                document.getElementById('statPending').innerText = data.totalIssued - data.totalRedeemed;
                document.getElementById('statValue').innerText = '₹' + (data.totalRedeemed * 50).toLocaleString();

                // 2. Render Charts
                renderCharts(data);

                // 3. Render Table
                const tbody = document.getElementById('stallTableBody');
                tbody.innerHTML = data.stalls.map(s => `
                    <tr>
                        <td><strong>${s.name}</strong><br><small style="color:#666">${s.id}</small></td>
                        <td>${s.count}</td>
                        <td>${new Date(s.lastActive).toLocaleTimeString()}</td>
                        <td class="amount-highlight">₹${(s.count * 50).toLocaleString()}</td>
                    </tr>
                `).join('');

            } catch (e) {
                console.error(e);
            }
        }

        function renderCharts(data) {
            // Hourly Chart
            new Chart(document.getElementById('timeChart'), {
                type: 'line',
                data: {
                    labels: data.hourlyStats.labels,
                    datasets: [{
                        label: 'Coupons Redeemed',
                        data: data.hourlyStats.values,
                        borderColor: '#00d2ff',
                        backgroundColor: 'rgba(0, 210, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // Dept Pie Chart
            new Chart(document.getElementById('deptChart'), {
                type: 'doughnut',
                data: {
                    labels: data.deptStats.map(d => d.dept),
                    datasets: [{
                        data: data.deptStats.map(d => d.count),
                        backgroundColor: ['#ff00cc', '#00d2ff', '#ffcc00', '#00ff88', '#888']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.onload = loadStats;
    </script>
</body>
</html>
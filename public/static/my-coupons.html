<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Food Coupons | LAKSHYA 2K26</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .coupon-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .coupon-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .dashed-border { 
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='8%2c8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); 
        }

        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="glass-header sticky top-0 z-50 w-full py-4 px-6 mb-8 shadow-sm">
        <div class="max-w-6xl mx-auto flex flex-col items-center justify-center">
            <h1 class="text-2xl font-extrabold tracking-tight text-slate-900">
                LAKSHYA <span class="text-blue-500">2K26</span>
            </h1>
            <p class="text-sm font-medium text-slate-500 mt-1 uppercase tracking-wider">Official Food Coupons</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-6xl mx-auto px-4 pb-12 flex flex-col items-center">
        
        <!-- Loading State -->
        <div id="loading" class="text-center py-20">
            <div class="relative w-16 h-16 mx-auto">
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p class="mt-6 text-slate-500 font-medium animate-pulse">Retrieving your secure coupons...</p>
        </div>

        <!-- Error State -->
        <div id="error-msg" class="hidden w-full max-w-lg mx-auto bg-white border border-red-100 rounded-2xl shadow-lg p-6 mb-8 text-center">
            <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-1">Access Error</h3>
            <p class="text-slate-500 text-sm mb-4" id="error-text">Unable to load coupons.</p>
            <a href="/login" class="inline-flex items-center justify-center px-4 py-2 bg-slate-900 text-white text-sm font-medium rounded-lg hover:bg-slate-800 transition-colors">
                Return to Login
            </a>
        </div>

        <!-- Coupons Grid -->
        <div id="coupons-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 w-full hidden">
            <!-- Coupons injected via JS -->
        </div>

        <!-- No Coupons State -->
        <div id="no-coupons" class="hidden text-center py-16">
            <div class="bg-white p-10 rounded-3xl shadow-xl border border-slate-100 max-w-md mx-auto">
                <div class="text-6xl mb-6">üéüÔ∏è</div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">No Active Coupons</h3>
                <p class="text-slate-500">You haven't been issued any food coupons yet. Please complete your kit collection at the venue.</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto py-8 bg-white border-t border-slate-200">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-slate-600 text-sm font-medium mb-2">
                Designed & Developed by 
                <a href="https://xetasolutions.in" target="_blank" class="text-blue-600 hover:text-blue-700 font-bold hover:underline decoration-2 underline-offset-2 transition-all">
                    Xeta Solutions
                </a>
            </p>
            <p class="text-xs text-slate-400 font-medium">
                A startup from <span class="text-slate-500">Department of AI&DS, LBRCE</span>
            </p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingEl = document.getElementById('loading');
            const containerEl = document.getElementById('coupons-container');
            const errorEl = document.getElementById('error-msg');
            const noCouponsEl = document.getElementById('no-coupons');

            // 1. Detect Logic: Public Link or Logged In User?
            const urlParams = new URLSearchParams(window.location.search);
            const publicId = urlParams.get('id');

            let apiUrl = '/api/participant/my-coupons'; // Default: Private API
            
            if (publicId) {
                // If ID is present in URL, use the new Public API
                apiUrl = `/api/public/coupons/${publicId}`;
            }

            try {
                const response = await fetch(apiUrl);
                
                // Handle Not Authorized
                if (response.status === 401) {
                    if (!publicId) {
                        window.location.href = '/login'; 
                        return;
                    }
                }

                if (!response.ok) throw new Error('Failed to load data');

                const coupons = await response.json();

                loadingEl.classList.add('hidden');

                if (coupons.length === 0) {
                    noCouponsEl.classList.remove('hidden');
                    return;
                }

                containerEl.classList.remove('hidden');

                // Render Coupons
                coupons.forEach((coupon, index) => {
                    const isRedeemed = coupon.status === 'REDEEMED';
                    
                    // Styling logic
                    const cardBorder = isRedeemed ? 'border-slate-200' : 'border-blue-100 ring-4 ring-blue-50/50';
                    const badgeClass = isRedeemed 
                        ? 'bg-slate-100 text-slate-500 border border-slate-200' 
                        : 'bg-green-50 text-green-600 border border-green-200 shadow-sm';
                    const qrContainerClass = isRedeemed ? 'opacity-30 grayscale' : 'bg-white shadow-inner';
                    
                    const card = document.createElement('div');
                    card.className = `coupon-card relative rounded-3xl border ${cardBorder} flex flex-col overflow-hidden`;
                    
                    card.innerHTML = `
                        <!-- Status Banner if Redeemed -->
                        ${isRedeemed ? `
                        <div class="absolute inset-0 z-10 flex items-center justify-center pointer-events-none">
                            <div class="bg-slate-100/90 backdrop-blur-sm border border-slate-200 text-slate-500 text-sm font-bold px-4 py-2 rounded-full transform -rotate-12 shadow-sm">
                                REDEEMED ‚Ä¢ ${new Date(coupon.redeemedAt).toLocaleDateString()}
                            </div>
                        </div>` : ''}

                        <!-- Decorative Header -->
                        <div class="h-3 w-full ${isRedeemed ? 'bg-slate-200' : 'bg-gradient-to-r from-cyan-400 via-blue-500 to-indigo-500'}"></div>
                        
                        <div class="p-6 flex-grow flex flex-col">
                            <!-- Header Info -->
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 tracking-tight">Food Coupon</h3>
                                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mt-1">#${String(index + 1).padStart(2, '0')}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-[10px] font-bold tracking-wide uppercase ${badgeClass}">
                                    ${coupon.status}
                                </span>
                            </div>

                            <!-- QR Section -->
                            <div class="dashed-border rounded-2xl p-6 mb-6 flex items-center justify-center bg-slate-50/50 relative group">
                                <div id="qrcode-${index}" class="p-2 bg-white rounded-xl shadow-sm transition-all duration-300 ${qrContainerClass}"></div>
                            </div>

                            <!-- Code Section -->
                            <div class="text-center mt-auto">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Secret Code</p>
                                <button onclick="copyToClipboard('${coupon.code}', this)" 
                                    class="w-full bg-slate-50 hover:bg-slate-100 border border-slate-200 border-dashed rounded-xl px-4 py-3 font-mono font-bold text-lg text-slate-700 tracking-wider transition-colors active:scale-95 group relative overflow-hidden">
                                    <span class="relative z-10">${coupon.code}</span>
                                    <span class="absolute inset-0 bg-green-50 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-200"></span>
                                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 group-hover:text-green-500 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                </button>
                                <p class="text-xs text-slate-400 mt-4 font-medium">
                                    ${isRedeemed 
                                        ? 'This coupon is no longer valid' 
                                        : 'Present this QR code at any food stall'}
                                </p>
                            </div>
                        </div>
                    `;

                    containerEl.appendChild(card);

                    // Generate QR Code with refined colors
                    setTimeout(() => {
                        const qrContainer = document.getElementById(`qrcode-${index}`);
                        qrContainer.innerHTML = ''; // Clear previous if any
                        new QRCode(qrContainer, {
                            text: coupon.code,
                            width: 140,
                            height: 140,
                            colorDark : isRedeemed ? "#94a3b8" : "#1e293b",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.Q
                        });
                    }, 100);
                });

            } catch (err) {
                console.error(err);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                document.getElementById('error-text').innerText = "The link is invalid or expired.";
            }
        });

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalContent = btn.innerHTML;
                
                // Temporary success state
                btn.style.borderColor = '#86efac'; // green-300
                btn.style.backgroundColor = '#f0fdf4'; // green-50
                btn.innerHTML = `
                    <div class="flex items-center justify-center gap-2 text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-sm">Copied!</span>
                    </div>
                `;

                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.borderColor = '';
                    btn.style.backgroundColor = '';
                }, 1500);
            });
        }
    </script>
</body>
</html>